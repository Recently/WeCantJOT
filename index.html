<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jack of Trades Auto-Detect Overlay</title>
  <script src="https://alt1addons.s3.amazonaws.com/alt1/alt1as.js"></script>
  <style>
    /* Red “X” style */
    .xmark {
      position: absolute;
      font-size: 32px;
      font-weight: bold;
      color: rgba(255, 0, 0, 0.85);
      pointer-events: none;
      user-select: none;
    }
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="status">Initializing…</div>
  <script>
    (async () => {
      // 1) Grab the RS3 client rectangle (in screen coords).
      const gameRect = await alt1.getGameClient();
      if (!gameRect) {
        document.getElementById("status").innerText = "Could not find RS3 window.";
        return;
      }

      // 2) List of all “Jack of Trades” skill names (must match PNG filenames in skill-icons/)
      const skillNames = [
        "Attack", "Constitution", "Mining", "Strength", "Agility", "Smithing",
        "Defence", "Herblore", "Fishing", "Ranged", "Thieving", "Cooking",
        "Prayer", "Crafting", "Firemaking", "Magic", "Fletching", "Woodcutting",
        "Runecraft", "Slayer", "Farming", "Construction", "Hunter", "Summoning",
        "Dungeoneering", "Divination", "Invention"
      ];

      // 3) Load all template images for each skill
      function loadTemplate(name) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.src = `skill-icons/${name}.png`;
          img.onload = () => resolve({ name, img });
          img.onerror = () => reject(`Failed to load template for ${name}`);
        });
      }

      let templates = [];
      try {
        templates = await Promise.all(skillNames.map(loadTemplate));
      } catch (err) {
        document.getElementById("status").innerText = 
          "Error loading skill-icon templates: " + err;
        return;
      }

      document.getElementById("status").innerText = "Template images loaded. Capturing screen…";

      // 4) Capture a snapshot of the entire RS3 window
      const fullSnap = await alt1.captureRegion(
        gameRect.x, gameRect.y, gameRect.width, gameRect.height
      );

      document.getElementById("status").innerText = "Detecting skill positions…";

      // 5) For each template, run alt1.findSubimage to locate it on the screenshot.
      //    We’ll build a map: skillName → { x: absoluteX, y: absoluteY }.
      const skillMap = {}; 
      for (const { name, img } of templates) {
        // threshold 0.9 (you can tweak if icons have slight variations)
        const matches = await alt1.findSubimage(fullSnap, img, 0.9);
        if (matches.length) {
          // pick the first match
          const { x, y } = matches[0];
          // x,y are relative to the top-left of fullSnap; add gameRect.x/y to get absolute
          skillMap[name] = { x: gameRect.x + x, y: gameRect.y + y };
        } else {
          console.warn(`Could not locate ${name} icon on screen.`);
        }
      }

      const foundCount = Object.keys(skillMap).length;
      document.getElementById("status").innerText =
        `Detected ${foundCount}/${skillNames.length} skills. Starting overlay.`;

      // 6) Keep track of which skills have already been marked
      const doneSkills = new Set();

      // 7) Helper to overlay a red “X” centered at (absX, absY)
      function placeRedX(absX, absY) {
        const el = document.createElement("div");
        el.classList.add("xmark");
        el.textContent = "✘";
        // Subtract a few pixels so the ✘ centers nicely
        el.style.left = `${absX - gameRect.x - 12}px`;
        el.style.top  = `${absY - gameRect.y - 12}px`;
        document.body.appendChild(el);
      }

      // 8) Main loop: read new chat lines each frame
      let lastIndex = 0;
      async function frameUpdate() {
        const allLines = await alt1.chat.readAll();
        for (let i = lastIndex; i < allLines.length; i++) {
          const line = allLines[i].replace(/\u00A0/g, " ").trim();
          const m = line.match(
            /You gain experience in (\w+) and have now completed \d+\/25 skills for your Jack of Trades aura\./
          );
          if (m) {
            const skillName = m[1];
            if (!doneSkills.has(skillName) && skillMap[skillName]) {
              doneSkills.add(skillName);
              const { x: absX, y: absY } = skillMap[skillName];
              placeRedX(absX, absY);
            }
          }
        }
        lastIndex = allLines.length;
        window.requestAnimationFrame(frameUpdate);
      }

      frameUpdate();
    })();
  </script>
</body>
</html>
