<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>We Cant Jack of Trades</title>

  <!-- You can keep Bootstrap’s CSS if you need it, but remove the Bootstrap JS (which needs jQuery). -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous"
  >
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/nis/nis.css" />
  <link rel="stylesheet" type="text/css" href="css/style.css">

  <script type="text/javascript" src="https://runeapps.org/runeappslib.js"></script>
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/runeappslib.css">

  <!-- ==== ALT1 MODULES (UNPKG CDN) ==== -->
  <!-- These must come before your own script so that `alt1.*` is defined. -->
  <script src="https://unpkg.com/alt1/dist/base/index.js"></script>
  <script src="https://unpkg.com/alt1/dist/chatbox/index.js"></script>
  <!-- If you need OCR or buffs later, you can add:
       <script src="https://unpkg.com/alt1/dist/ocr/index.js"></script>
       <script src="https://unpkg.com/alt1/dist/buffs/index.js"></script>
  -->
  <!-- ================================ -->

  <!-- Remove bosstimer.bundle.js since it’s not needed for JOT functionality -->
  <!-- <script src="scripts/bosstimer.bundle.js"></script> -->

  <style>
    /* Red “X” style */
    .xmark {
      position: absolute;
      font-size: 32px;
      font-weight: bold;
      color: rgba(255, 0, 0, 0.85);
      pointer-events: none;
      user-select: none;
    }
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="status">Initializing…</div>

  <script>
    (async () => {
      // 1) Verify that alt1.getGameClient exists (i.e. UNPKG modules loaded)
      if (typeof alt1.getGameClient !== "function") {
        document.getElementById("status").innerText =
          "Error: alt1.getGameClient is undefined. Are you running inside Alt1?";
        return;
      }

      // 2) Grab the RS3 window rectangle
      const gameRect = await alt1.getGameClient();
      if (!gameRect) {
        document.getElementById("status").innerText =
          "Could not find the RuneScape 3 client window.";
        return;
      }

      // 3) List all Jack of Trades skill names (PNG files must be in skill-icons/)
      const skillNames = [
        "Attack","Constitution","Mining","Strength","Agility","Smithing",
        "Defence","Herblore","Fishing","Ranged","Thieving","Cooking",
        "Prayer","Crafting","Firemaking","Magic","Fletching","Woodcutting",
        "Runecraft","Slayer","Farming","Construction","Hunter","Summoning",
        "Dungeoneering","Divination","Invention",
        "Necromancy","Archaeology"
      ];

      // 4) Load each template image from “skill-icons/<SkillName>-icon.png”
      function loadTemplate(name) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.src = `skill-icons/${name}-icon.png`;
          img.onload = () => resolve({ name, img });
          img.onerror = () => reject(`Failed to load ${name}-icon.png`);
        });
      }

      let templates;
      try {
        templates = await Promise.all(skillNames.map(loadTemplate));
      } catch (err) {
        document.getElementById("status").innerText =
          "Error loading skill-icon templates: " + err;
        return;
      }
      document.getElementById("status").innerText =
        "Templates loaded. Capturing screen…";

      // 5) Capture a one-time snapshot of the entire RS3 window
      const fullSnap = await alt1.captureRegion(
        gameRect.x, gameRect.y, gameRect.width, gameRect.height
      );
      document.getElementById("status").innerText =
        "Detecting skill positions…";

      // 6) For each template, run findSubimage on fullSnap (threshold 0.9)
      //    Build skillMap: { "<SkillName>": { x: absX, y: absY } }
      const skillMap = {};
      for (const { name, img } of templates) {
        const matches = await alt1.findSubimage(fullSnap, img, 0.9);
        if (matches.length) {
          const { x, y } = matches[0]; // relative to the RS3 window
          skillMap[name] = { x: gameRect.x + x, y: gameRect.y + y };
        } else {
          console.warn(`Could not locate ${name}-icon.png on screen.`);
        }
      }

      const foundCount = Object.keys(skillMap).length;
      document.getElementById("status").innerText =
        `Detected ${foundCount}/${skillNames.length} skills. Starting overlay.`;

      // 7) Track which skills have already been flagged
      const doneSkills = new Set();

      // 8) Function to overlay a red “✘” at (absX, absY)
      function placeRedX(absX, absY) {
        const el = document.createElement("div");
        el.classList.add("xmark");
        el.textContent = "✘";
        // Center the “✘” on the icon
        el.style.left = `${absX - gameRect.x - 12}px`;
        el.style.top  = `${absY - gameRect.y - 12}px`;
        document.body.appendChild(el);
      }

      // 9) Main loop: read all chat lines once per animation frame
      let lastIndex = 0;
      async function frameUpdate() {
        const allLines = await alt1.chat.readAll();
        for (let i = lastIndex; i < allLines.length; i++) {
          const line = allLines[i].replace(/\u00A0/g, " ").trim();
          const m = line.match(
            /You gain experience in (\w+) and have now completed \d+\/25 skills for your Jack of Trades aura\./
          );
          if (m) {
            const skillName = m[1];
            if (!doneSkills.has(skillName) && skillMap[skillName]) {
              doneSkills.add(skillName);
              const { x: absX, y: absY } = skillMap[skillName];
              placeRedX(absX, absY);
            }
          }
        }
        lastIndex = allLines.length;
        window.requestAnimationFrame(frameUpdate);
      }
      frameUpdate();
    })();
  </script>
</body>
</html>
